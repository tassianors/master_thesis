%===============================================================================
\section{Algoritmo para identificação de modelos racionais}
\label{sec:nl_si_algorithms_rationals}
%===============================================================================

Esta seção descreve um algoritmo para determinar os parâmetros de modelos racionais
do tipo apresentado em \eqref{eq:nl_model_narmax_rat_simp}. Este algoritmo foi proposto por
\cite{correa} e é uma modificação do algoritmo originalmente proposto por
\cite{billings_zhu}. Assume-se que o modelo pode ser aproximado por: \cite{aguirre}

\begin{eqnarray}\nonumber
y(t)&=&\frac
{a(y(t-1), ..., y(t-n_y), u(t-1), ..., u(t-n_u))}
{b(y(t-1), ..., y(t-n_y), u(t-1), ..., u(t-n_u))}\\
&&  +c(e(t-1), ... , e(t-n_e)) +e(t)
\label{eq:nl_alg_rational}
\end{eqnarray}

Onde o ruído é modelado por um polinômio que pode ou não ser linear. A consideração básica 
por trás de \eqref{eq:nl_alg_rational} é que o erro de regressão pode ser representado por
um modelo {\it{MA}}({\it{Move average}}), possivelmente não linear. Assim sendo sugere-se o 
seguinte procedimento: \cite{aguirre}

\begin{enumerate}

%==========================================================================
% Step 1
\item Faça $i=0$. Monte a matriz de regressão e estime os coeficiente usando
o método dos mínimos quadrados.

\begin{equation}
\begin{bmatrix}
\hat{\theta}_n^i\\ 
\hat{\theta}_{d1}^i
\end{bmatrix}=\left [ \Psi ^T \Psi \right ]^{-1}\Psi^T y^*
\label{nl_alg_rational_step_1}
\end{equation}

onde o índice $i$ indica a iteração. Além disso a matriz de regressores $\Psi$ é 
formada tomando-se os vetores de regressores $\psi_n(t-1)$ e $\psi_{d1}(t-1)$ ao longo
da janela de dados do tamanho $N$, ou seja:

\begin{equation}
\Psi=\begin{bmatrix}
\psi_n^T(t-1) & \psi_{d1}^T(t-1)\\ 
\vdots & \vdots \\ 
\psi_n^T(t+N-2) & \psi_{d1}^T(t+N-2)
\end{bmatrix}
\nonumber
\end{equation}

Analogamente o vetor $y^* \in \mathbb{R} ^{N \times 1}$ é formado tomando os dados,
ou seja:

\begin{equation}
y^{*T}=\left [ y^*(t), y^*(t+1), ..., y^*(t+N-1) \right ]
\nonumber
\end{equation}

%==========================================================================
% Step 2
\item Faça $i=i+1$. Determine os resíduos e sua variância, respectivamente como:

\begin{equation}
\xi ^i(t)=y(t)-\frac{\psi_n^T(t-1)\hat{\theta}_n}{\psi_{d}^T(t-1)\hat{\theta}_d}
\label{nl_alg_rational_step2_res}
\end{equation}

\begin{equation}
\left ( \sigma _{\xi}^2 \right )^i=\frac{1}{N-m_d}\sum_{i=m_d+1}^{N}\left ( \xi ^i(t) \right )^2
\label{eq:nl_alg_rational_step2_var}
\end{equation}

onde $N$ é o tamanho dos dados e $m_d=max(n_y, n_u, n_e)$.

%==========================================================================
% Step 3
\item Usando-se os resíduos determinados no passo anterior, atualize $\Psi ^T \Psi$ e $\Psi^T y^*$
usando \eqref{eq:nl_alg_rational_step3_psi}


\begin{equation}
\Psi=\begin{bmatrix}
\psi_{n}^T(t-1) & y(t)\psi_{d1}^T(t-1)  & \psi_{\xi }^T(t-1) \\ 
\vdots & \vdots & \vdots\\ 
\psi_{n}^T(t+N-2) & y(t)\psi_{d1}^T(t+N-2)  & \psi_{\xi }^T(t+N-2)
\end{bmatrix}
\label{eq:nl_alg_rational_step3_psi}
\end{equation}

Onde $\psi_{\xi }$ é o vetor de regressores do modelo do ruído. Pelo fato do ruído não ser medido,
os resíduos do passo (2) são utilizados.

%==========================================================================
% Step 4
\item Determine

\begin{equation}
\Phi =\begin{bmatrix}
0      & \dots & 0      & 0 & \dots & 0 & \dots & 0 & \dots & 0\\ 
\vdots &       & \vdots & \vdots &  & \vdots &  & \vdots &  & \vdots\\ 
0      & \dots & 0      & \sum_{t=1}^{N}p_{d2}^2 & \dots & \sum_{t=1}^{N}p_{d2}p_{d_{N_d}}  & \dots & 0 & \dots & 0\\ 
\vdots &       & \vdots & \vdots &  & \vdots &  & \vdots &  & \vdots\\ 
0      & \dots & 0      & \sum_{t=1}^{N}p_{dN_d}p_{d2} & \dots & \sum_{t=1}^{N}p_{d_{N_d}}^2 & \dots & 0 & \dots & 0 
\end{bmatrix}
\label{eq:nl_alg_rational_step5_Psi}
\end{equation}

\begin{equation}
\phi =\begin{bmatrix}
0\\ 
\vdots\\ 
0\\ 
-\sum_{k=1}^{N} p_{d2}p_{d1}\\ 
\vdots\\ 
-\sum_{k=1}^{N} p_{dN_d}p_{d1}\\ 
0\\ 
\vdots\\
0
\end{bmatrix}
\label{eq:nl_alg_rational_step5_phi}
\end{equation}


E estime novamente os parâmetros utilizando:

\begin{equation}
\begin{bmatrix}
\hat{\theta}_n^i\\ 
\hat{\theta}_{d1}^i
\end{bmatrix}=\left [ \Psi^T \Psi - (\sigma _{\xi}^2)^i \Phi  \right ]^{-1}
\left [ \Psi^T y^* - (\sigma _{\xi}^2)^i \phi \right ]
\label{eq:nl_alg_rational_step5}
\end{equation}

%==========================================================================
% Step 5
\item Volte ao passo 2 até atingir convergência (de parâmetro ou de variância de resíduo).
\end{enumerate} % Aguirre algorithm for rational model identification pg 394


A convergência do algoritmo depende da convergência da estimativa da sequência do ruído.
\cite{billings_zhu91} 

%===============================================================================
\subsection{Exemplos ilustrativos}
\label{sec:nl_si_algorithms_rationals_examples}
%===============================================================================

Nesta seção serão apresentados alguns casos de uso do algoritmo descrito anteriormente. 
Inicia-se com um exemplo simples, onde o sistema é racional e a classe de modelos escolhida consegue representar
completamente este sistema ($\mathcal{S} \in \mathcal{M}$). Em seguida será apresentado um exemplo onde o sistema ainda
é racional, mas a classe de modelos escolhida não consegue representar completamente o sistema em questão, ou seja,
$\mathcal{S} \notin \mathcal{M}$. Por fim será apresentado um exemplo real de um conversor de corrente contínua para
corrente contínua do tipo Buck.

Serão apresentados os resultados obtidos a fim de verificar a qualidade dos resultados obtidos e a confiabilidade do
algoritmo em questão.

%===============================================================================
\subsubsection{Sistemas originalmente racionais}
\label{sec:nl_si_algorithms_rationals_ex1}
%===============================================================================

Considere o sistema real:

\begin{equation}
y(t)=\frac{0.2 y(t-1)+0.1 y(t-1)u(t-1)+ u(t-1)}{1+y^{2}(t-1)+y^{2}(t-2)}+e(t)
\label{eq:nl_rat_exemple2}
\end{equation}

O modelo escolhido para representar o sistema real é:

\begin{equation}
y(t)=\frac{\theta_1 y(t-1)+\theta_2 y(t-1)u(t-1)+ \theta_3u(t-1)}{1+\theta_4 y^{2}(t-1)+ \theta_5y^{2}(t-2)}
\label{eq:nl_rat_exemple2_model}
\end{equation}


Utilizando para simulação um sinal PRBS de 635 pontos e adicionando-se um ruído $e(t)$ de variância $\sigma^2=0.005$ os
resultados da média de 100 estimativas de Monte Carlo foram:

\begin{equation}
\theta_{\text{média}} =\begin{bmatrix}
0.1991  &  0.0995  &  0.9963  &  0.9899  &  0.9912
\end{bmatrix}
\nonumber
\end{equation}

A variância encontrada foi de:

\begin{equation}
\theta_{\text{variância}} =1.0\times 10^{-4} \begin{bmatrix}
0.0089  &  0.0073  &  0.1082  &  0.7179  &  0.7910
\end{bmatrix}
\nonumber
\end{equation}

E a matriz de covariância é:

\begin{equation}
\theta_{\text{Covariância}} =1.0\times 10^{-4} \begin{bmatrix}
    0.0089 & -0.0005 & 0.0112 & 0.0213 & 0.0339 \\
   -0.0005 &  0.0073 & 0.0057 & 0.0220 & 0.0091 \\
    0.0112 &  0.0057 & 0.1082 & 0.2529 & 0.2589 \\
    0.0213 &  0.0220 & 0.2529 & 0.7179 & 0.4987 \\
    0.0339 &  0.0091 & 0.2589 & 0.4987 & 0.7910
\end{bmatrix}
\nonumber
\end{equation}

Utilizando a média das estimativas para simular a saída do modelo obtido com o sistema real, obteve-se um
custo:

\begin{equation}
V(\theta)=1.1269\times 10^{-4}
\nonumber
\end{equation}

A fim de melhor ilustrar a estimativa obtida, na Figura \ref{fig:nl_rat_example2} são apresentadas as
estimativas dos parâmetros $\theta_1$ e $\theta_2$ e a elipse de confiança para $\chi^2=95\%$.

\begin{figure}[htbp]
	\center
	\includegraphics[width=0.9\columnwidth]{figures/rat_example2_a1_a2.eps}
	\caption{Estimativas obtidas nos 100 experimentos de Monte Carlo realizados para as variáveis $\theta_1$ e
	$\theta_2$.}
	\label{fig:nl_rat_example2}
\end{figure}

%===============================================================================
\subsubsection{Sistemas originalmente racionais, quando $\mathcal{S} \notin \mathcal{M}$}
\label{sec:nl_si_algorithms_rationals_ex2}
%===============================================================================

O sistema descrito abaixo será utilizado para a simulação: 

\begin{equation}
y(t)=\frac{\theta_1y(t-1)+\theta_2y(t-1)u(t-1)+\theta_3u(t-1)}{1+\theta_4y^{2}(t-1)+\theta_5y^{2}(t-2)}
\label{eq:nl_rat_exemple3}
\end{equation}

Para o sistema real utilizou-se os valores de referência:

\begin{equation}
\theta = 
\begin{bmatrix}
0.2 & 0.1 & 1 & 1 & 1
\end{bmatrix}
\nonumber
\end{equation}


Escolheu-se um modelo que não consegue representar totalmente o comportamento do sistema \eqref{eq:nl_rat_exemple3}:

\begin{equation}
y(t)=\frac{\theta_1y(t-1)+\theta_2u(t-1)}{1+\theta_3y^{2}(t-1)+\theta_4y^{2}(t-2)}
\label{eq:nl_rat_exemple3_model}
\end{equation}

Utilizando par a simulação um sinal PRBS de 635 pontos e um ruído de variância $\sigma^2=0.005$ os resultados
da média de 100 estimativas de Monte Carlo foram:

\begin{equation}
\theta_{\text{média}} =\begin{bmatrix}
0.2279  &  1.1341  &  1.2716  &  1.3769
\end{bmatrix}
\nonumber
\end{equation}

A variância encontrada foi de:

\begin{equation}
\theta+{\text{variância}} =1.0\times 10^{-3} \begin{bmatrix}
0.0020  &  0.0535  &  0.3402  &	  0.3217
\end{bmatrix}
\nonumber
\end{equation}

A fim de comparar a qualidade dos resultados obtidos, na Figura (\ref{fig:nl_rat_example3}) é apresentado a resposta do
sistema real \eqref{eq:nl_rat_exemple3} e o sistema obtido pela estimativa utilizando o a classe de modelos
\eqref{eq:nl_rat_exemple3_model} para uma entrada do tipo degrau unitário.

\begin{figure}[htbp]
	\center
	\includegraphics[width=0.9\columnwidth]{figures/rat_example3.eps}
	\caption{Comparação do sistema real e do sistema estimado do modelo \eqref{eq:nl_rat_exemple3_model}. Comparativo dos
	sistemas para uma entrada do tipo degrau unitário.}
	\label{fig:nl_rat_example3}
\end{figure}

O custo obtido para o modelo estimado foi de:

\begin{equation}
V(\theta)=1.1239
\nonumber
\end{equation}

%===============================================================================
\subsubsection{Conversor CC-CC Buck}
\label{sec:nl_si_algorithms_rationals_buck}
% Aguirre 397
% Tese do corrêa - pg 27
%===============================================================================
O conversor de corrente continua do tipo Buck possui um mapa que pode ser obtido a partir da equação do
circuito que tem a forma como em \eqref{eq:nl_alg_buck_circ}. O circuito do
conversor é apresentado na Figura (\ref{fig:nl_models_buck_circuit}). \cite{tse_buck}

\begin{equation}
y(t)=\alpha y(t-1)+\frac{h(d_n)^2 \beta E\left [ E-y(t-1) \right ]}{y(t-1)}
\label{eq:nl_alg_buck_circ}
\end{equation}

Sendo $\alpha = 0.8872$, $\beta = 1.2$ e $E=33$ constantes que dependem apenas dos componentes do
circuito eletrônico. $d_n$ é um sinal de tensão que implementa a ação de controle e a saturação
$h(d_n)$ é dada por :

\begin{equation}
h(d_n)=\left\{\begin{matrix}
0 & \text{se } d_n < 0\\ 
1 & \text{se } d_n > 1\\ 
d_n & \text{caso contrario.}
\end{matrix}\right.
\nonumber
\end{equation}

\begin{figure}[htbp]
	\center
	\includegraphics[width=0.55\columnwidth]{figures/nl_models_buck_circuit.eps}
	\caption{Circuito do conversor CC-CC Buck}
	\label{fig:nl_models_buck_circuit}
\end{figure}

Modelos polinomiais não resultam em bons modelos para a dinâmica de \eqref{eq:nl_alg_buck_circ}. Um
modelo com estrutura {\it{ad rock}}, que aproxima relativamente bem a característica estática do
conversor é: \cite{aguirre_maps}

\begin{equation}
y(t)=O exp\left [ 22-y(t-1) \right ]+ \frac{a\; y(t-1)^2 -b\; y(t-1)+c}{y(t-1)}
\nonumber
\end{equation}

Onde $O=46.429$, $a=2.6204$, $b=99.875$ e $c=1.4171\times 10^3$. Por outro lado a 

Para aplicar o algoritmo, escolhe-se inicialmente um modelo para o sistema em análise. O modelo
racional \eqref{eq:nl_alg_buck_rational} aproxima bem a dinâmica em questão.

\begin{equation}
y(t)=\frac{8.658+0.1223\times10^{-2}y(t-1)^3-0.441\times10^{-1}y(t-1)^2}
{1-0.8381\times10^{-1}y(t-1)+0.1766\times10^{-2}y(t-1)^2}
\label{eq:nl_alg_buck_rational}
\end{equation}

Tendo o modelo escolhido é possível aplicar o algoritmo apresentado na seção
(\ref{sec:nl_si_algorithms_rationals}). 

Os parâmetros da equação \eqref{eq:nl_alg_buck_rational} são os valores de referência para a utilização do
métodos descrito em \cite{aguirre}. Utilizando o algoritmo previamente apresentado, o resultado da estimativa
foi:

\begin{equation}
\theta =\begin{bmatrix}
8.8807 & 8.6698\times 10^{-4} &-0.0359 &-0.0736 & 0.0013 
\end{bmatrix}
\nonumber
\end{equation}

Como pode ser observado, pelos resultados de $\theta$ obtidos e os valores esperados, existe polarização na
estimativa obtida. Isso em parte se dá pela falta de capacidade da classe de modelos escolhida em representar
o processo real e pela escolha do modelo de ruído que para este caso foi apenas utilizado o erro da
estimativa, com relação a saída do sistema real obtido.

Foram utilizadas amostras de 100 pontos para esta estimativa e realizados 100 experimentos de Monte Carlo.
Os resultados obtidos foram de uma média de:

\begin{equation}
\text{média de }\;\theta =\begin{bmatrix}
8.8976  &    8.6762\times 10^{-4}    & -0.0360 &  -0.0736  &  0.0013
\end{bmatrix}
\nonumber
\end{equation}

e uma variância de

\begin{equation}
\theta_{\text{variância}} =\begin{bmatrix}
0.4842\times 10^{-3}  \\ 1.8004\times 10^{-12} \\ 3.5416\times 10^{-9} \\ 1.9850\times 10^{-9} \\ 2.4100\times
10^{-12}
\end{bmatrix}^T
\nonumber
\end{equation}

com uma covariância de 

\begin{equation}
\theta_{\text{Covariância}} = 1.0\times 10^{-3}\begin{bmatrix}
 0.4842 &  0.0000 & -0.0011 &  0.0007 &-0.0000 \\
 0.0000 &  0.0000 & -0.0000 & -0.0000 & 0.0000 \\
-0.0011 & -0.0000 &  0.0000 & -0.0000 & 0.0000 \\
 0.0007 & -0.0000 & -0.0000 &  0.0000 &-0.0000 \\
-0.0000 &  0.0000 &  0.0000 & -0.0000 & 0.0000 
\end{bmatrix}
\nonumber
\end{equation}

